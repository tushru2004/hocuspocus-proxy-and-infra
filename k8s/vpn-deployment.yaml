apiVersion: apps/v1
kind: Deployment
metadata:
  name: vpn-server
  namespace: hocuspocus
  labels:
    app: vpn-server
    app.kubernetes.io/managed-by: argocd
    app.kubernetes.io/name: hocuspocus-vpn
spec:
  replicas: 1
  selector:
    matchLabels:
      app: vpn-server
      app.kubernetes.io/managed-by: argocd
      app.kubernetes.io/name: hocuspocus-vpn
  strategy:
    type: Recreate  # Required for RWO PVC - can't have 2 pods mounting same PVC
  template:
    metadata:
      labels:
        app: vpn-server
        app.kubernetes.io/managed-by: argocd
        app.kubernetes.io/name: hocuspocus-vpn
    spec:
      # Use host networking for VPN
      hostNetwork: true
      dnsPolicy: ClusterFirstWithHostNet

      # Init container to set up iptables
      initContainers:
        - name: iptables-setup
          image: alpine:3.19
          command:
            - /bin/sh
            - -c
            - |
              set -e
              echo "Installing iptables..."
              apk add --no-cache iptables

              echo "Setting up iptables rules..."

              # Enable IP forwarding
              echo 1 > /proc/sys/net/ipv4/ip_forward

              # Get default interface (using sed since busybox grep/awk may not work)
              IFACE=$(ip route get 8.8.8.8 | sed -n 's/.* dev \([^ ]*\).*/\1/p')
              echo "Default interface: $IFACE"

              # NAT for VPN clients
              iptables -t nat -A POSTROUTING -s 10.10.10.0/24 -o $IFACE -j MASQUERADE
              iptables -A FORWARD -m state --state RELATED,ESTABLISHED -j ACCEPT
              iptables -A FORWARD -s 10.10.10.0/24 -j ACCEPT

              # REDIRECT HTTP/HTTPS to mitmproxy (port 8080 on localhost)
              # Using REDIRECT (not DNAT) because VPN uses hostNetwork and mitmproxy
              # runs on the same node - REDIRECT preserves original destination for transparent proxy
              MITMPROXY_PORT="8080"
              echo "Redirecting traffic to mitmproxy on port $MITMPROXY_PORT"
              iptables -t nat -A PREROUTING -s 10.10.10.0/24 -p tcp --dport 80 -j REDIRECT --to-port $MITMPROXY_PORT
              iptables -t nat -A PREROUTING -s 10.10.10.0/24 -p tcp --dport 443 -j REDIRECT --to-port $MITMPROXY_PORT

              # Block QUIC to force HTTPS fallback
              iptables -I FORWARD -p udp --dport 443 -s 10.10.10.0/24 -j REJECT

              echo "iptables setup complete"
          securityContext:
            privileged: true
            capabilities:
              add:
                - NET_ADMIN
                - NET_RAW

      containers:
        - name: strongswan
          image: europe-west1-docker.pkg.dev/hocuspocus-vpn/hocuspocus-vpn/vpn:latest
          imagePullPolicy: Always

          securityContext:
            privileged: true
            capabilities:
              add:
                - NET_ADMIN
                - NET_RAW

          env:
            - name: VPN_SERVER_IP
              value: "35.210.225.36"  # External LoadBalancer IP for certificate CN
            - name: VPN_USERNAME
              valueFrom:
                secretKeyRef:
                  name: vpn-secrets
                  key: VPN_USERNAME
            - name: VPN_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: vpn-secrets
                  key: VPN_PASSWORD
            - name: SETUP_IPTABLES
              value: "false"  # Handled by init container

          ports:
            - name: ike
              containerPort: 500
              hostPort: 500
              protocol: UDP
            - name: nat-t
              containerPort: 4500
              hostPort: 4500
              protocol: UDP

          volumeMounts:
            - name: vpn-certs
              mountPath: /etc/ipsec.d
            - name: modules
              mountPath: /lib/modules
              readOnly: true

          resources:
            requests:
              cpu: 25m
              memory: 64Mi
            limits:
              cpu: 200m
              memory: 128Mi

          livenessProbe:
            exec:
              command:
                - ipsec
                - status
            initialDelaySeconds: 30
            periodSeconds: 30

      volumes:
        - name: vpn-certs
          persistentVolumeClaim:
            claimName: vpn-certs-pvc
        - name: modules
          hostPath:
            path: /lib/modules
            type: Directory

      tolerations:
        - operator: Exists
          effect: NoSchedule
